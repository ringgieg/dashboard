# Promtail configuration for collecting logs and sending to Loki

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Example: Collect logs from /logs directory
  - job_name: tasks
    static_configs:
      - targets:
          - localhost
        labels:
          job: tasks
          service: Batch-Sync
          __path__: /logs/batch-sync/**/*.log

      - targets:
          - localhost
        labels:
          job: tasks
          service: Data-Service
          __path__: /logs/data-service/**/*.log

    pipeline_stages:
      # Extract log level from log line
      - regex:
          expression: '^\[(?P<timestamp>.*?)\]\s+(?P<level>ERROR|WARN|INFO|DEBUG|TRACE)\s+'

      # Extract task name from filename
      - regex:
          expression: '.*\/(?P<task_name>[^\/]+)\.log'
          source: filename

      # Add extracted fields as labels
      - labels:
          level:
          task_name:

      # Parse timestamp
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05.000'
